<!doctype html>
<html>

<head>
    <title>Project M Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Courier New", Courier, monospace;
            background-color: #36393F;
            margin: 5px
        }

        #specialEffects {
            width: auto;
            height: 22pt;
            border-style: solid;
            border-width: 1px;
            border-color: #CCFF33;
            color: #FFF;
            position: relative;
            text-align: center;
        }

        #columnRight {
            width: 250px;
            height: 100vh;
            border-style: solid;
            border-width: 1px;
            border-color: #CC0000;
            color: #FFF;
            padding: 5px 2px;
            text-align: center;
            top: 0;
            position: absolute;
            right: 0;
        }

        #map {
            width: 250px;
            height: 250px;
            border-style: solid;
            border-width: 1px;
            border-color: #CCBB00;
            color: #FFF;
            padding: 5px 2px;
            text-align: center;
            vertical-align: middle;
            top: 0;
            position: absolute;
            right: 0;
        }

        #server-info {
            width: auto;
            border-style: solid;
            border-width: 1px;
            border-color: #CCBBBB;
            font-family: monospace;
            font-size: 10pt;
            text-align: left;
            vertical-align: middle;
            top: 185pt;
            position: relative;
            padding: 5px;
        }

        #server-info input[type=text] {
            background-color: #36393F;
            color: white;
            font-size: 10pt;
            font-family: monospace;
        }


        #regionInfo {
            width: 250px;
            height: 150px;
            border-style: solid;
            border-width: 1px;
            border-color: #CCBBBB;
            color: #FFF;
            padding: 5px 2px;
            bottom: 0;
            text-align: center;
            position: absolute;
            right: 0;
        }

        #statusAndQA {
            width: 100vh;
            height: 24pt;
            border-style: solid;
            border-width: 1px;
            border-color: #AABBAA;
            color: #FFF;
            padding: 5px 2px;
            text-align: center;
            bottom: 32pt;
            position: absolute;
            left: 0;
            z-index: 1000;
        }

        #boxMsg {
            background: #AABBAA;
            color: #FFF;
            bottom: 0;
            position: absolute;
            left: 0;
            z-index: 1000;
        }

        #boxMsg input[type=text] {
            background-color: #36393F;
            color: white;
            font-size: 16pt;
            width: auto;
        }

        #messagesFromSrv {
            padding: 10px;
            color: white;
        }

        pre {
            padding: px 10px;
        }

        #messagesFromSrv p:nth-child(odd) {
            background: #36393F;
            font-family: monospace;
            font-size: 12pt;
            color: #fff;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script>
        console.ok = msg => {
            console.log( `%c ${msg}`, "font-weight: bold; font-color: green" );
        };

        console.err = msg => {
            console.log( `%c ${msg}`, "font-weight: bold; font-color: red" );
        };

        var test_client = {};
        test_client.deleteCnn = s => {
            s.disconnect();
            delete s;
        };

        $( document ).ready( function () {
            const urlParams = new URLSearchParams( window.location.search );
            const token = urlParams.get( 'token' );
            const character_id = urlParams.get( 'character_id' );
            var add = $( "#serverAddress" ).val();
            var port = $( "#serverPort" ).val();

            var socket = {};
            socket.io = io( `http://${add}:${port}` );

            socket.io.on( 'connect', {
                reconnect: false
            }, function ( data ) {

                // Client side event listener. It takes new messages from the server and appends it to HTML.
                console.ok( 'connected' );

                if ( !socket.io.connected )
                    return;
            } ); // socket connected

            socket.io.on( 'connect_error', error => {
                console.err( `CNN ERROR: ${error}` );
                test_client.deleteCnn( socket.io );
            } );
            socket.io.on( 'error', error => {
                console.err( `CNN ERROR: ${error}` );
                test_client.deleteCnn( socket.io );
            } );
            socket.io.on( 'connect_timeout', error => {
                console.err( `CNN ERROR: ${error}` );
                test_client.deleteCnn( socket.io );
            } );

            //More Details https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver
            // select the target node
            var target = document.getElementById( 'messagesFromSrv' )
            // create an observer instance
            var observer = new MutationObserver( m => {
                target.scrollTop = target.scrollHeight;
                console.log( "Scroll bottom" );
            } );

            // pass in the target node, as well as the observer options
            observer.observe( target, {
                attributes: true,
                childList: true,
                characterData: true
            } );

            // authenticate = function () {
            //     console.log( 'Authenticating character id ' + character_id + ' with token: ' + token )
            //     socket.io.emit(
            //         'auth',
            //         JSON.stringify( {
            //             'character_id': character_id,
            //             'token': token
            //         } ),
            //         function () {
            //             console.log( 'auth call done' );
            //         }
            //     )
            // }
            // addMsg = function ( msg ) {
            //     const pre = $( ' <pre> </pre>' );
            // $( '#messagesFromSrv' ).append( pre.text( msg ) );
            // }




            // socket.io.on( 'msg', message => {
            //     $( '#cnn' ).val( "connected" );
            //     addMsg( message.data )
            // } );

            // socket.io.on( 'auth', message => {
            //     console.log( message )
            //     socket.authenticated_channel = io( '/' + message.data.channel_id )
            //     socket.authenticated_channel.on( 'msg', x => {
            //         addMsg( 'PRIVCHAN: ' + x )
            //     } )
            //     socket.authenticated_channel.on( 'connect', y => {
            //         addMsg( 'Connected to PRIVCHAN ' + message.data.channel_id )
            //     } )

            // } );

            // $( '#msgToServer' ).on( 'keypress', function ( e ) {
            //     if ( e.which == 13 ) {
            //         console.log( 'enter' )
            //         socket.io.emit(
            //             'msg',
            //             JSON.stringify( {
            //                 "ctx": "world",
            // "data": $( '#msgToServer' ).val()
            //             } ),
            //             () => {
            // $( '#msgToServer' ).val( '' )
            //             }
            //         );
            //     }
            // } );

        } ); // document ready
    </script>
</head>

<body>
    <div id="specialEffects">
        Special effect in the room
    </div>

    <div id="output">
        <div id="messagesFromSrv" style="overflow-y: scroll;">
        </div>
    </div>

    <div id="columnRight">
        <div id="map">
            Map
        </div>
        <div id="server-info">

            <!-- I tag tipo con parentesi graffe sono jinja template. leave it here, gli hostname li setta
                     il server. -->

            <span>add:</span>&nbsp;<input id="serverAddress" type="text" value="{{context.ws_host}}">
            <p></p>
            <span>port:</span>&nbsp;<input id="serverPort" type="text" value="{{context.ws_port}}">
            <p></p>
            <button type="button" name="cnn" id="cnn">Connect</button>
        </div>
    </div>

    <div id="regionInfo">
        Region info
    </div>

    <div id="statusAndQA">
        Status and Quick actions
    </div>

    <div id="boxMsg">
        <input autocomplete="off" type="text" id="msgToServer" placeholder="enter message">
    </div>

</body>

</html>